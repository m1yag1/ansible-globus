name: Release to Ansible Galaxy

on:
  push:
    tags:
      - 'v*'

env:
  PYTHON_VERSION: "3.12"

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          echo "tag_version=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "Tag version: $TAG_VERSION"

      - name: Get version from galaxy.yml
        id: get_galaxy_version
        run: |
          GALAXY_VERSION=$(grep '^version:' galaxy.yml | awk '{print $2}' | tr -d '"')
          echo "galaxy_version=$GALAXY_VERSION" >> $GITHUB_OUTPUT
          echo "Galaxy version: $GALAXY_VERSION"

      - name: Verify version match
        run: |
          if [ "${{ steps.get_version.outputs.tag_version }}" != "${{ steps.get_galaxy_version.outputs.galaxy_version }}" ]; then
            echo "âŒ Version mismatch!"
            echo "   Git tag: v${{ steps.get_version.outputs.tag_version }}"
            echo "   galaxy.yml: ${{ steps.get_galaxy_version.outputs.galaxy_version }}"
            echo ""
            echo "Please update galaxy.yml version to match the git tag."
            exit 1
          fi
          echo "âœ… Version match confirmed: ${{ steps.get_version.outputs.tag_version }}"

      - name: Check CHANGELOG.md
        run: |
          if ! grep -q "\[${{ steps.get_version.outputs.tag_version }}\]" CHANGELOG.md; then
            echo "âš ï¸ Warning: Version ${{ steps.get_version.outputs.tag_version }} not found in CHANGELOG.md"
            echo "Please update CHANGELOG.md before releasing"
          else
            echo "âœ… CHANGELOG.md contains entry for ${{ steps.get_version.outputs.tag_version }}"
          fi

  build:
    name: Build Collection
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install tox
        run: |
          uv pip install --system tox tox-uv

      - name: Build collection with tox
        run: |
          tox -e galaxy-build

      - name: Verify build
        run: |
          ls -lh _build/
          if [ ! -f _build/community-globus-*.tar.gz ]; then
            echo "âŒ Build failed: tarball not found"
            exit 1
          fi
          echo "âœ… Build successful"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ansible-collection
          path: _build/community-globus-*.tar.gz
          retention-days: 5

  publish-galaxy:
    name: Publish to Ansible Galaxy
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          uv pip install --system tox tox-uv ansible-core>=2.16.0

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ansible-collection
          path: _build/

      - name: Publish to Ansible Galaxy
        env:
          ANSIBLE_GALAXY_TOKEN: ${{ secrets.ANSIBLE_GALAXY_TOKEN }}
        run: |
          if [ -z "$ANSIBLE_GALAXY_TOKEN" ]; then
            echo "âŒ ANSIBLE_GALAXY_TOKEN not set"
            echo "Please add your Ansible Galaxy token to GitHub secrets"
            exit 1
          fi

          # Use bash to expand glob pattern
          bash -c 'ansible-galaxy collection publish _build/community-globus-*.tar.gz --token $ANSIBLE_GALAXY_TOKEN'
          echo "âœ… Published to Ansible Galaxy"

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, build, publish-galaxy]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ansible-collection
          path: _build/

      - name: Extract release notes from CHANGELOG
        id: changelog
        run: |
          # Extract release notes for this version from CHANGELOG.md
          if grep -q "\[${{ steps.get_version.outputs.version }}\]" CHANGELOG.md; then
            # Extract section for this version
            awk '/\[${{ steps.get_version.outputs.version }}\]/,/^## \[/{print}' CHANGELOG.md | sed '$d' > release_notes.md

            # Add installation instructions
            cat >> release_notes.md << EOF

          ## Installation

          \`\`\`bash
          ansible-galaxy collection install community.globus:${{ steps.get_version.outputs.version }}
          \`\`\`

          ## Documentation

          See the [README](https://github.com/m1yag1/ansible-globus/blob/v${{ steps.get_version.outputs.version }}/README.md) for full documentation.
          EOF
          else
            # Fallback to generic message if CHANGELOG not updated
            cat > release_notes.md << EOF
          Release v${{ steps.get_version.outputs.version }} of the Ansible Globus Collection.

          ## Installation

          \`\`\`bash
          ansible-galaxy collection install community.globus:${{ steps.get_version.outputs.version }}
          \`\`\`

          ## Documentation

          See the [README](https://github.com/m1yag1/ansible-globus/blob/main/README.md) for full documentation.
          EOF
          fi

          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          files: _build/community-globus-*.tar.gz
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.version, '-') }}
          generate_release_notes: false

  test-installation:
    name: Test Installation from Galaxy
    runs-on: ubuntu-latest
    needs: publish-galaxy

    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core>=2.16.0

      - name: Get version
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Wait for Galaxy indexing
        run: |
          echo "â³ Waiting 60 seconds for Galaxy to index the new release..."
          sleep 60

      - name: Install collection from Galaxy
        run: |
          ansible-galaxy collection install community.globus:${{ steps.get_version.outputs.version }}
          echo "âœ… Collection installed successfully"

      - name: Verify installation
        run: |
          ansible-galaxy collection list | grep community.globus
          INSTALLED_VERSION=$(ansible-galaxy collection list | grep community.globus | awk '{print $2}')
          echo "Installed version: $INSTALLED_VERSION"

          if [ "$INSTALLED_VERSION" != "${{ steps.get_version.outputs.version }}" ]; then
            echo "âš ï¸ Version mismatch: expected ${{ steps.get_version.outputs.version }}, got $INSTALLED_VERSION"
            exit 1
          fi
          echo "âœ… Version verification passed"

  notify:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [validate, build, publish-galaxy, create-github-release, test-installation]
    if: always()

    steps:
      - name: Get version
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Success summary
        if: ${{ !contains(needs.*.result, 'failure') }}
        run: |
          echo "ğŸš€ Release v${{ steps.get_version.outputs.version }} completed successfully!"
          echo ""
          echo "âœ… Validation: ${{ needs.validate.result }}"
          echo "âœ… Build: ${{ needs.build.result }}"
          echo "âœ… Publish to Galaxy: ${{ needs.publish-galaxy.result }}"
          echo "âœ… GitHub Release: ${{ needs.create-github-release.result }}"
          echo "âœ… Installation Test: ${{ needs.test-installation.result }}"
          echo ""
          echo "ğŸ“¦ Collection available at:"
          echo "   - Ansible Galaxy: https://galaxy.ansible.com/ui/repo/published/community/globus/"
          echo "   - GitHub Release: https://github.com/m1yag1/ansible-globus/releases/tag/v${{ steps.get_version.outputs.version }}"
          echo ""
          echo "ğŸ“š Documentation: https://github.com/m1yag1/ansible-globus/blob/main/README.md"

      - name: Failure summary
        if: ${{ contains(needs.*.result, 'failure') }}
        run: |
          echo "âŒ Release v${{ steps.get_version.outputs.version }} encountered failures"
          echo ""
          echo "Validation: ${{ needs.validate.result }}"
          echo "Build: ${{ needs.build.result }}"
          echo "Publish to Galaxy: ${{ needs.publish-galaxy.result }}"
          echo "GitHub Release: ${{ needs.create-github-release.result }}"
          echo "Installation Test: ${{ needs.test-installation.result }}"
          echo ""
          echo "Please check the logs and fix any issues before retrying."
          exit 1
